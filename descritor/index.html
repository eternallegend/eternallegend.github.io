<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <link rel="profile" href="https://gmpg.org/xfn/11">
    <title>Descritor de imagens para cegos, feito por eternal legend.</title>
</head>
<body>
    <div class="nv-page-title">
        <h1>Descritor de imagens da eternal legend.</h1>
    </div>
    <div class="nv-content-wrap entry-content">
        <form id="recognizeForm" enctype="multipart/form-data">
            <label for="file">Arquivo de Imagem:</label>
            <input type="file" id="file" name="file">

            <label for="url">URL da Imagem:</label>
            <input type="text" id="url" name="url" placeholder="Insira a URL da imagem">

            <label for="lang">Selecionar Idioma:</label>
            <select id="lang" name="lang"></select>

            <label for="target">O que reconhecer:</label>
            <select id="target" name="target">
                <option value="all">Tudo</option>
                <option value="text">Apenas Texto</option>
                <option value="images">Apenas Imagens</option>
                <option value="nothing">Nada</option>
            </select>

            <div class="checkbox">
                <input type="checkbox" id="qr" name="qr" value="1">
                <label for="qr">Ler códigos QR/BAR</label>
            </div>

            <div class="checkbox">
                <input type="checkbox" id="bm" name="bm" value="1">
                <label for="bm">Usar Be My AI</label>
            </div>

            <div class="checkbox">
                <input type="checkbox" id="translate" name="translate" value="1">
                <label for="translate">Traduzir texto reconhecido</label>
            </div>

            <input type="submit" value="Reconhecer Imagem">
        </form>

        <div id="result"></div>
        <button id="copyButton" class="copy-button" style="display:none;">Copiar para a Área de Transferência</button>
        <div id="saveOptions" style="display:none;">
            <label for="saveFormat">Salvar como:</label>
            <select id="saveFormat">
                <option value="json">JSON</option>
                <option value="txt">Texto (TXT)</option>
            </select>
            <button onclick="saveResult()">Salvar</button>
        </div>

        <script src="api.js" defer></script>
        <script>
            const langSelect = document.getElementById('lang');

            // Adicionar opções de idioma ao seletor de idioma
            async function addLanguageOptions() {
                try {
                    const languages = await getAvailableLanguages();
                    languages.forEach(lang => {
                        const option = document.createElement('option');
                        option.value = lang.code;
                        option.textContent = lang.name;
                        langSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Erro ao carregar idiomas:', error);
                }
            }

            // Executar quando a página carregar
            window.onload = function() {
                addLanguageOptions();
            };

            // Lidar com o envio do formulário
            document.getElementById('recognizeForm').addEventListener('submit', async function(event) {
                event.preventDefault();

                const formData = new FormData(this);
                const resultDiv = document.getElementById('result');
                const copyButton = document.getElementById('copyButton');
                const saveOptions = document.getElementById('saveOptions');
                resultDiv.innerHTML = "Processando...";
                copyButton.style.display = "none";
                saveOptions.style.display = "none";

                try {
                    const recognitionData = await recognizeImage(formData);

                    if (recognitionData.status === 'ok') {
                        const id = recognitionData.id;
                        resultDiv.innerHTML = "<div class='section-title'>Aguardando Reconhecimento...</div>";

                        // Função para verificar o resultado periodicamente
                        async function checkResult() {
                            try {
                                const resultData = await getResult(id);

                                if (resultData.status === 'notready') {
                                    console.log('Aguardando reconhecimento...');
                                    setTimeout(checkResult, 2000); // Polling a cada 2 segundos
                                } else if (resultData.status === 'ok') {
                                    let resultHtml = `<div class="section-title">Texto Reconhecido:</div><p>${resultData.text}</p>`;
                                    resultDiv.innerHTML = resultHtml;
                                    copyButton.style.display = "block";
                                    saveOptions.style.display = "block";
                                } else {
                                    resultDiv.innerHTML = "Erro ao processar a imagem.";
                                }
                            } catch (error) {
                                console.error('Erro ao buscar resultados:', error);
                                resultDiv.innerHTML = "Erro ao buscar resultados.";
                            }
                        }

                        checkResult();
                    } else {
                        resultDiv.innerHTML = "Erro ao iniciar o reconhecimento.";
                    }
                } catch (error) {
                    console.error('Erro ao enviar a solicitação:', error);
                    resultDiv.innerHTML = "Erro ao enviar a solicitação.";
                }
            });

            // Função para copiar o resultado para a área de transferência
            document.getElementById('copyButton').addEventListener('click', function() {
                const resultText = document.getElementById('result').innerText;
                navigator.clipboard.writeText(resultText)
                    .then(() => alert("Texto copiado com sucesso!"))
                    .catch(err => console.error('Erro ao copiar texto: ', err));
            });

            // Função para salvar o resultado conforme a opção selecionada
            function saveResult() {
                const saveFormat = document.getElementById('saveFormat').value;
                switch (saveFormat) {
                    case 'json':
                        saveAsJson();
                        break;
                    case 'txt':
                        saveAsTxt();
                        break;
                    default:
                        break;
                }
            }

            // Função para salvar como JSON
            function saveAsJson() {
                const resultJson = { text: document.getElementById('result').innerText };
                const blob = new Blob([JSON.stringify(resultJson)], { type: 'application/json' });
                saveAs(blob, 'resultado.json');
            }

            // Função para salvar como arquivo de texto (.txt)
            function saveAsTxt() {
                const resultText = document.getElementById('result').innerText;
                const blob = new Blob([resultText], { type: 'text/plain' });
                saveAs(blob, 'resultado.txt');
            }

            // Função para salvar arquivos
            function saveAs(blob, filename) {
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        </script>
    </div>
</body>
</html>
